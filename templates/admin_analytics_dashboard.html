<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - Kaboy Agrovet Admin</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-container {
            padding: 2rem;
            background: #f8f9fa;
            min-height: 100vh;
        }
        .analytics-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .analytics-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        .analytics-card:hover {
            transform: translateY(-5px);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }
        .insight-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: none;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <!-- Header -->
        <div class="analytics-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> Advanced Analytics Dashboard</h1>
                    <p class="mb-0">Comprehensive insights into your business performance</p>
                </div>
                <div class="col-md-4 text-right">
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-light">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="analyticsTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab">
                    <i class="fas fa-tachometer-alt"></i> Overview
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="customers-tab" data-toggle="tab" href="#customers" role="tab">
                    <i class="fas fa-users"></i> Customer Insights
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="products-tab" data-toggle="tab" href="#products" role="tab">
                    <i class="fas fa-box"></i> Product Performance
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="forecast-tab" data-toggle="tab" href="#forecast" role="tab">
                    <i class="fas fa-chart-line"></i> Sales Forecast
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="branches-tab" data-toggle="tab" href="#branches" role="tab">
                    <i class="fas fa-building"></i> Branch Performance
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="analyticsTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="totalCustomers">-</div>
                            <div class="metric-label">Total Customers</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="avgOrderValue">-</div>
                            <div class="metric-label">Avg Order Value</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="topProductRevenue">-</div>
                            <div class="metric-label">Top Product Revenue</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="forecastTrend">-</div>
                            <div class="metric-label">Sales Trend</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <h5><i class="fas fa-chart-pie"></i> Customer Categories</h5>
                            <div class="chart-container">
                                <canvas id="customerCategoriesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <h5><i class="fas fa-chart-bar"></i> Top Products</h5>
                            <div class="chart-container">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Insights Tab -->
            <div class="tab-pane fade" id="customers" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="analytics-card">
                            <h5><i class="fas fa-chart-line"></i> Customer Acquisition Over Time</h5>
                            <div class="chart-container">
                                <canvas id="customerAcquisitionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analytics-card">
                            <h5><i class="fas fa-star"></i> Top Customers</h5>
                            <div id="topCustomersList">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="analytics-card">
                            <h5><i class="fas fa-lightbulb"></i> Customer Insights</h5>
                            <div id="customerInsights">
                                <div class="loading">Loading insights...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Performance Tab -->
            <div class="tab-pane fade" id="products" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <h5><i class="fas fa-chart-bar"></i> Category Performance</h5>
                            <div class="chart-container">
                                <canvas id="categoryPerformanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <h5><i class="fas fa-exclamation-triangle"></i> Low Stock Alerts</h5>
                            <div id="lowStockAlerts">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="analytics-card">
                            <h5><i class="fas fa-table"></i> Product Performance Table</h5>
                            <div class="table-responsive">
                                <table class="table table-striped" id="productPerformanceTable">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Total Sold</th>
                                            <th>Revenue</th>
                                            <th>Stock Level</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Forecast Tab -->
            <div class="tab-pane fade" id="forecast" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="analytics-card">
                            <h5><i class="fas fa-chart-line"></i> Sales Forecast (Next 30 Days)</h5>
                            <div class="chart-container">
                                <canvas id="salesForecastChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analytics-card">
                            <h5><i class="fas fa-info-circle"></i> Forecast Metrics</h5>
                            <div id="forecastMetrics">
                                <div class="loading">Loading metrics...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="analytics-card">
                            <h5><i class="fas fa-calendar"></i> Historical Sales Data</h5>
                            <div class="chart-container">
                                <canvas id="historicalSalesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Branch Performance Tab -->
            <div class="tab-pane fade" id="branches" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <h5><i class="fas fa-chart-bar"></i> Branch Sales Comparison</h5>
                            <div class="chart-container">
                                <canvas id="branchSalesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <h5><i class="fas fa-chart-pie"></i> Branch Profit Distribution</h5>
                            <div class="chart-container">
                                <canvas id="branchProfitChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="analytics-card">
                            <h5><i class="fas fa-table"></i> Branch Performance Table</h5>
                            <div class="table-responsive">
                                <table class="table table-striped" id="branchPerformanceTable">
                                    <thead>
                                        <tr>
                                            <th>Branch</th>
                                            <th>Total Sales</th>
                                            <th>Transactions</th>
                                            <th>Avg Transaction</th>
                                            <th>Expenses</th>
                                            <th>Net Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    
    <script>
        // Global variables for charts
        let charts = {};

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
            loadCustomerInsights();
            loadProductPerformance();
            loadSalesForecast();
            loadBranchPerformance();
        });

        // Overview Data
        async function loadOverviewData() {
            try {
                const [customerData, productData, forecastData] = await Promise.all([
                    fetch('/api/analytics/customer-insights').then(r => r.json()),
                    fetch('/api/analytics/product-performance').then(r => r.json()),
                    fetch('/api/analytics/sales-forecast').then(r => r.json())
                ]);

                if (customerData.status === 'success') {
                    document.getElementById('totalCustomers').textContent = customerData.data.customer_categories.total_customers;
                    
                    // Customer categories chart
                    const customerCtx = document.getElementById('customerCategoriesChart').getContext('2d');
                    charts.customerCategories = new Chart(customerCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Total Customers', 'Active (30 days)', 'Active (90 days)'],
                            datasets: [{
                                data: [
                                    customerData.data.customer_categories.total_customers,
                                    customerData.data.customer_categories.active_30_days,
                                    customerData.data.customer_categories.active_90_days
                                ],
                                backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }

                if (productData.status === 'success') {
                    const topProduct = productData.data.top_products[0];
                    if (topProduct) {
                        document.getElementById('topProductRevenue').textContent = `KSh ${topProduct.total_revenue.toLocaleString()}`;
                    }

                    // Top products chart
                    const productsCtx = document.getElementById('topProductsChart').getContext('2d');
                    const topProducts = productData.data.top_products.slice(0, 5);
                    charts.topProducts = new Chart(productsCtx, {
                        type: 'bar',
                        data: {
                            labels: topProducts.map(p => p.name),
                            datasets: [{
                                label: 'Revenue (KSh)',
                                data: topProducts.map(p => p.total_revenue),
                                backgroundColor: '#667eea'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                if (forecastData.status === 'success') {
                    const trend = forecastData.data.metrics.trend;
                    const trendText = trend > 0 ? `+${trend.toFixed(1)}%` : `${trend.toFixed(1)}%`;
                    document.getElementById('forecastTrend').textContent = trendText;
                }

            } catch (error) {
                console.error('Error loading overview data:', error);
            }
        }

        // Customer Insights
        async function loadCustomerInsights() {
            try {
                const response = await fetch('/api/analytics/customer-insights');
                const data = await response.json();

                if (data.status === 'success') {
                    // Customer acquisition chart
                    const acquisitionCtx = document.getElementById('customerAcquisitionChart').getContext('2d');
                    const acquisitionData = data.data.customer_acquisition.slice(-30);
                    charts.customerAcquisition = new Chart(acquisitionCtx, {
                        type: 'line',
                        data: {
                            labels: acquisitionData.map(d => d.date),
                            datasets: [{
                                label: 'New Customers',
                                data: acquisitionData.map(d => d.new_customers),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Top customers list
                    const topCustomersHtml = data.data.top_customers.map(customer => `
                        <div class="insight-item">
                            <strong>${customer.name}</strong><br>
                            <small>${customer.email}</small><br>
                            <span class="badge badge-primary">${customer.order_count} orders</span>
                            <span class="badge badge-success">KSh ${customer.total_spent.toLocaleString()}</span>
                        </div>
                    `).join('');
                    document.getElementById('topCustomersList').innerHTML = topCustomersHtml;

                    // Customer insights
                    const insightsHtml = `
                        <div class="insight-item">
                            <strong>Customer Retention:</strong> ${((data.data.customer_categories.active_30_days / data.data.customer_categories.total_customers) * 100).toFixed(1)}% of customers ordered in the last 30 days
                        </div>
                        <div class="insight-item">
                            <strong>Average Order Value:</strong> KSh ${(data.data.top_customers.reduce((sum, c) => sum + c.avg_order_value, 0) / data.data.top_customers.length).toFixed(2)}
                        </div>
                        <div class="insight-item">
                            <strong>Top Customer Value:</strong> KSh ${data.data.top_customers[0]?.total_spent.toLocaleString() || 0}
                        </div>
                    `;
                    document.getElementById('customerInsights').innerHTML = insightsHtml;
                }
            } catch (error) {
                console.error('Error loading customer insights:', error);
            }
        }

        // Product Performance
        async function loadProductPerformance() {
            try {
                const response = await fetch('/api/analytics/product-performance');
                const data = await response.json();

                if (data.status === 'success') {
                    // Category performance chart
                    const categoryCtx = document.getElementById('categoryPerformanceChart').getContext('2d');
                    charts.categoryPerformance = new Chart(categoryCtx, {
                        type: 'bar',
                        data: {
                            labels: data.data.category_performance.map(c => c.category),
                            datasets: [{
                                label: 'Revenue (KSh)',
                                data: data.data.category_performance.map(c => c.total_revenue),
                                backgroundColor: '#764ba2'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Low stock alerts
                    const lowStockHtml = data.data.low_stock_products.map(product => `
                        <div class="insight-item">
                            <strong>${product.name}</strong> (${product.variant})<br>
                            <span class="badge badge-warning">Stock: ${product.stock_level}</span>
                            <span class="badge badge-info">Price: KSh ${product.selling_price}</span>
                        </div>
                    `).join('');
                    document.getElementById('lowStockAlerts').innerHTML = lowStockHtml || '<p>No low stock items</p>';

                    // Product performance table
                    const tableBody = document.querySelector('#productPerformanceTable tbody');
                    const tableHtml = data.data.top_products.map(product => `
                        <tr>
                            <td>${product.name} (${product.variant})</td>
                            <td>${product.total_sold}</td>
                            <td>KSh ${product.total_revenue.toLocaleString()}</td>
                            <td>${product.stock_level}</td>
                            <td>
                                <span class="badge badge-${product.stock_level < 10 ? 'danger' : 'success'}">
                                    ${product.stock_level < 10 ? 'Low Stock' : 'In Stock'}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                    tableBody.innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('Error loading product performance:', error);
            }
        }

        // Sales Forecast
        async function loadSalesForecast() {
            try {
                const response = await fetch('/api/analytics/sales-forecast');
                const data = await response.json();

                if (data.status === 'success') {
                    // Sales forecast chart
                    const forecastCtx = document.getElementById('salesForecastChart').getContext('2d');
                    const historicalData = data.data.historical_sales.slice(-30);
                    const forecastData = data.data.forecast;

                    charts.salesForecast = new Chart(forecastCtx, {
                        type: 'line',
                        data: {
                            labels: [...historicalData.map(d => d.date), ...forecastData.map(d => d.date)],
                            datasets: [
                                {
                                    label: 'Historical Sales',
                                    data: [...historicalData.map(d => d.sales), ...Array(30).fill(null)],
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    fill: false
                                },
                                {
                                    label: 'Forecast',
                                    data: [...Array(historicalData.length).fill(null), ...forecastData.map(d => d.predicted_sales)],
                                    borderColor: '#764ba2',
                                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                    borderDash: [5, 5],
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Historical sales chart
                    const historicalCtx = document.getElementById('historicalSalesChart').getContext('2d');
                    charts.historicalSales = new Chart(historicalCtx, {
                        type: 'line',
                        data: {
                            labels: data.data.historical_sales.map(d => d.date),
                            datasets: [{
                                label: 'Daily Sales',
                                data: data.data.historical_sales.map(d => d.sales),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Forecast metrics
                    const metricsHtml = `
                        <div class="insight-item">
                            <strong>Average Daily Sales:</strong> KSh ${data.data.metrics.avg_daily_sales.toFixed(2)}
                        </div>
                        <div class="insight-item">
                            <strong>Trend:</strong> ${data.data.metrics.trend > 0 ? '+' : ''}${data.data.metrics.trend.toFixed(2)}%
                        </div>
                        <div class="insight-item">
                            <strong>Confidence Level:</strong> ${data.data.metrics.confidence_level}
                        </div>
                    `;
                    document.getElementById('forecastMetrics').innerHTML = metricsHtml;
                }
            } catch (error) {
                console.error('Error loading sales forecast:', error);
            }
        }

        // Branch Performance
        async function loadBranchPerformance() {
            try {
                const response = await fetch('/api/analytics/branch-performance');
                const data = await response.json();

                if (data.status === 'success') {
                    // Branch sales chart
                    const salesCtx = document.getElementById('branchSalesChart').getContext('2d');
                    charts.branchSales = new Chart(salesCtx, {
                        type: 'bar',
                        data: {
                            labels: data.data.map(b => b.branch_name),
                            datasets: [{
                                label: 'Total Sales (KSh)',
                                data: data.data.map(b => b.total_sales),
                                backgroundColor: '#667eea'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Branch profit chart
                    const profitCtx = document.getElementById('branchProfitChart').getContext('2d');
                    charts.branchProfit = new Chart(profitCtx, {
                        type: 'doughnut',
                        data: {
                            labels: data.data.map(b => b.branch_name),
                            datasets: [{
                                data: data.data.map(b => b.net_profit),
                                backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });

                    // Branch performance table
                    const tableBody = document.querySelector('#branchPerformanceTable tbody');
                    const tableHtml = data.data.map(branch => `
                        <tr>
                            <td>${branch.branch_name} (${branch.branch_code})</td>
                            <td>KSh ${branch.total_sales.toLocaleString()}</td>
                            <td>${branch.total_transactions}</td>
                            <td>KSh ${branch.avg_transaction_value.toFixed(2)}</td>
                            <td>KSh ${branch.total_expenses.toLocaleString()}</td>
                            <td>
                                <span class="badge badge-${branch.net_profit >= 0 ? 'success' : 'danger'}">
                                    KSh ${branch.net_profit.toLocaleString()}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                    tableBody.innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('Error loading branch performance:', error);
            }
        }

        // Tab change handlers
        document.getElementById('customers-tab').addEventListener('click', function() {
            setTimeout(loadCustomerInsights, 100);
        });

        document.getElementById('products-tab').addEventListener('click', function() {
            setTimeout(loadProductPerformance, 100);
        });

        document.getElementById('forecast-tab').addEventListener('click', function() {
            setTimeout(loadSalesForecast, 100);
        });

        document.getElementById('branches-tab').addEventListener('click', function() {
            setTimeout(loadBranchPerformance, 100);
        });
    </script>
</body>
</html> 